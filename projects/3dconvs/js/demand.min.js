let dataNum=240,dataMax=135,dataMin=-135,dataMean=7.987,linear=d3.scaleLinear().domain([dataMin,dataMax]).range([.01,1]);var data,subdata,lPatchWidth=200,margin={top:50,right:20,bottom:120,left:50},width=1200-margin.right-margin.left,height=550-margin.top-margin.bottom,cellSize=width/46.4,x_elements=[1,2,3,4,5,6,7,8],y_elements=[16,15,14,13,12,11,10,9,8,7,6,5,4,3,2,1],xScale=d3.scaleBand().domain(x_elements).range([0,x_elements.length*cellSize]),xAxis=d3.axisBottom().scale(xScale).tickFormat(function(t){return t}),yScale=d3.scaleBand().domain(y_elements).range([0,y_elements.length*cellSize]),yAxis=d3.axisLeft().scale(yScale).tickFormat(function(t){return t}),legendScale=d3.scaleLinear().domain([dataMax,dataMin]).range([0,y_elements.length*cellSize]),legendAxis=d3.axisRight().scale(legendScale).tickFormat(function(t){return t});tooltip=d3.select("body").append("div").attr("class","tooltip"),toolval=tooltip.append("div");let updateg3;window.onload=function(){d3.json("3dconvs/data/bike_demand.json").then(function(t){function e(t,e){var a;t.selectAll(".cells").remove(),t.append("g").attr("class","cells").selectAll("rect").data(e).enter().append("rect").attr("class","cell").attr("width",cellSize).attr("height",cellSize).attr("x",function(t,e){return xScale(t[1])}).attr("y",function(t,e){return yScale(t[0])}).attr("fill",function(t){return d3.interpolatePiYG(linear(t[2]))}).style("opacity",.9).on("mouseover",function(t){a=this.style.fill,this.style.fill="rgb(255, 167, 167)",d3.select(this).style("opacity",.8)}).on("mouseout",function(){this.style.fill=a,d3.select(this).style("stroke","none"),d3.select(this).style("opacity",.8),tooltip.style("visibility","hidden")}).on("mousemove",function(t){tooltip.style("visibility","visible").style("top",d3.event.pageY-30+"px").style("left",d3.event.pageX+20+"px"),tooltip.select("div").html("Gap: "+t[2])})}function a(){var t=parseInt(k(v));_.attr("cx",b(b.invert(v))),D.text(data[t].t),subdata=data[t],e(d,subdata.real[0]),e(s,subdata.pred[0]),updateg3(c,t),r(new Date(data[t].t)),d3.select("#rmse").text(data[t].rmse),(v+=S/151)>S&&(y=!1,v=0,clearInterval(timer),z.text("Play"),console.log("Slider moving: "+y))}function r(t){g.selectAll("line.hand").data(getTimeOfOneDay(t)).attr("transform",function(t){var e=7*cellSize/2,a=7*cellSize/2;return"rotate("+("hour"==t[0]?t[1]%12*30:6*t[1])+","+e+","+a+")"})}dataMax=t.max,dataMean=t.mean,data=t.data,invertcolors=0,invertcolors&&colorHold.reverse();var l=d3.select(".heatmap").append("svg").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom),n=l.append("svg:defs"),i={w:200,h:400};n.append("svg:pattern").attr("id","traffic_background").attr("width",i.w).attr("height",i.h).attr("patternUnits","userSpaceOnUse").append("svg:image").attr("xlink:href","./images/map.jpg").attr("width",i.w).attr("height",i.h).attr("x",0).attr("y",0),d3.select(".heatmap").style("width",width+margin.left+margin.right);var d=l.append("g").attr("transform","translate("+margin.left+","+margin.top+")"),s=l.append("g").attr("transform","translate("+(margin.left+8.5*cellSize)+","+margin.top+")");create_demandmap(1,d,data[0].real[0],dataMean),create_demandmap(2,s,data[0].pred[0],dataMean),d3.select("#rmse").text(data[0].rmse);var c=l.append("g").attr("transform","translate("+(margin.left+20*cellSize)+","+margin.top+")");createDemandChart(c);var o=(n=l.append("defs")).append("linearGradient").attr("id","linear-gradient-in");o.attr("x1","0%").attr("y1","0%").attr("x2","0%").attr("y2","100%");for(var p=0;p<=100;p++)o.append("stop").attr("offset",p+"%").attr("stop-color",d3.interpolatePiYG(1-p/100));legend1=l.append("g"),legend1.attr("transform","translate("+19*cellSize+","+margin.top+")"),legend1.append("rect").attr("width",.5*cellSize).attr("height",16*cellSize).style("fill","url(#linear-gradient-in)"),legend1.append("g").attr("transform","translate(10,-10)").attr("class","y axis").call(legendAxis);var m=l.append("g").attr("transform","translate(0,"+(margin.top-10)+")");m.append("text").attr("x",4*cellSize).attr("class","headtitle in").text("Demand - Real"),m.append("text").attr("x",12.2*cellSize).attr("class","headtitle in").text("Demand - Prediction");var g=l.append("g").attr("class","clock").attr("transform","translate("+(margin.left+39.5*cellSize)+","+margin.top+")"),h=(d3.timeFormat("%Y"),d3.timeFormat("%Y-%m-%d %H:%M:%S")),f=d3.timeFormat("%m/%d"),x=(d3.timeParse("%m/%d/%y"),new Date("2014-09-21")),u=new Date("2014-10-01"),y=!1,v=0,S=width-9.5*cellSize,z=d3.select("#play-button"),w=d3.select("#error");z.style("top",11*cellSize).style("right",3*cellSize),w.style("width",7*cellSize).style("top",14*cellSize).style("right",.7*cellSize);var b=d3.scaleTime().domain([x,u]).range([0,S]).clamp(!0),k=d3.scaleLinear().domain([b.range()[0],b.range()[1]]).range([0,data.length-1]).clamp(!0),M=l.append("g").attr("class","slider").attr("transform","translate("+margin.left+","+20*cellSize+")");M.append("line").attr("class","track").attr("x1",b.range()[0]).attr("x2",b.range()[1]).select(function(){return this.parentNode.appendChild(this.cloneNode(!0))}).attr("class","track-inset").select(function(){return this.parentNode.appendChild(this.cloneNode(!0))}).attr("class","track-overlay").call(d3.drag().on("start",function(){M.interrupt()}).on("drag",function(){v=d3.event.x;var t=parseInt(k(v));_.attr("cx",b(b.invert(v))),D.text(data[t].t),console.log("currentFrame",t),subdata=data[t],e(d,subdata.real[0]),e(s,subdata.pred[0]),updateg3(c,t),r(new Date(data[t].t)),d3.select("#rmse").text(data[t].rmse)})),M.insert("g",".track-overlay").attr("class","ticks").attr("transform","translate(0,18)").selectAll("text").data(b.ticks(11)).enter().append("text").attr("x",b).attr("y",10).attr("text-anchor","middle").text(function(t){return f(t)});var _=M.insert("circle",".track-overlay").attr("class","handle").attr("r",9),D=g.append("text").attr("class","label").style("fill","#336").attr("text-anchor","middle").text(h(x)).attr("transform","translate("+3.5*cellSize+","+8*cellSize+")").text(data[0].t);z.on("click",function(){var t=d3.select(this);"Pause"==t.text()?(y=!1,clearInterval(timer),t.text("Play")):(y=!0,timer=setInterval(a,300),t.text("Pause")),console.log("Slider moving: "+y)}),showD3Clock(7*cellSize,g),r(new Date(data[0].t))})};
