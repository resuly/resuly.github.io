function create_heatmap(t,e,l,n,a){var r;e.selectAll("rect").append("g").data(l).enter().append("rect").attr("class","cell").attr("width",cellSize).attr("height",cellSize).attr("x",function(t,e){return xScale(t[1])}).attr("y",function(t,e){return yScale(t[0])}).attr("fill",function(t){return"in"==a?d3.interpolateBuPu(linear(t[2])):d3.interpolateGnBu(linear(t[2]))}).on("mouseover",function(t){r=this.style.fill,this.style.fill="rgb(255, 167, 167)",d3.select(this).style("opacity",.5),tooltip.style("visibility","visible").style("top",d3.event.pageY-30+"px").style("left",d3.event.pageX+20+"px"),tooltip.select("div").html("flow: "+t[2])}).on("mouseout",function(){this.style.fill=r,d3.select(this).style("stroke","none"),d3.select(this).style("opacity",1),tooltip.style("visibility","hidden")}),1==t&&e.append("g").attr("class","y axis").call(yAxis),e.append("g").attr("class","x axis").attr("transform","translate(10,"+(y_elements.length*cellSize+cellSize/2)+")").call(xAxis).selectAll("text").style("text-anchor","end").attr("dx","-.8em").attr("dy","-.5em")}function create_demandmap(t,e,l,n){var a;e.append("g").attr("class","traffic_background").append("rect").attr("width",8*cellSize).attr("height",16*cellSize).attr("x",0).attr("y",0).style("fill","url(#traffic_background)"),e.append("g").attr("class","cells").selectAll("rect").append("g").data(l).enter().append("rect").attr("class","cell").style("opacity",.9).attr("width",cellSize).attr("height",cellSize).attr("x",function(t,e){return xScale(t[1])}).attr("y",function(t,e){return yScale(t[0])}).attr("fill",function(t){return d3.interpolatePiYG(linear(t[2]))}).on("mouseover",function(t){a=this.style.fill,this.style.fill="rgb(255, 167, 167)",d3.select(this).style("opacity",1),tooltip.style("visibility","visible").style("top",d3.event.pageY-30+"px").style("left",d3.event.pageX+20+"px"),tooltip.select("div").html("Gap: "+t[2])}).on("mouseout",function(){this.style.fill=a,d3.select(this).style("stroke","none"),d3.select(this).style("opacity",.9),tooltip.style("visibility","hidden")}),1==t&&e.append("g").attr("class","y axis").call(yAxis),e.append("g").attr("class","x axis").attr("transform","translate(10,"+(y_elements.length*cellSize+cellSize/2)+")").call(xAxis).selectAll("text").style("text-anchor","end").attr("dx","-.8em").attr("dy","-.5em")}function createDemandChart(t){d3.csv("../data/pred_demands.csv",function(t){return{date:new Date(t.date),demand:+t.demand,gap:+t.gap,supply:+t.supply}}).then(function(e){var l={top:10,right:30,bottom:0,left:0},n=450-l.left-l.right,a=430-l.top-l.bottom,r=d3.scaleTime().range([0,n]),o=d3.scaleLinear().range([a,0]),s=d3.scaleOrdinal(d3.schemeCategory10),i=(d3.axisBottom().scale(r),d3.axisRight().scale(o)),c=d3.line().x(function(t){return r(t.date)}).y(function(t){return o(t.volume)}).curve(d3.curveBasis);s.domain(d3.keys(e[0]).filter(function(t){return"date"!==t})).range([d3.schemeCategory10[4],d3.schemeCategory10[1],d3.schemeCategory10[2]]);var u=s.domain().map(function(t){return{name:t,values:e.map(function(e){return{date:e.date,volume:+e[t]}})}});console.log("cities",u),r.domain(d3.extent(e,function(t){return t.date})),o.domain([d3.min(u,function(t){return d3.min(t.values,function(t){return t.volume})}),d3.max(u,function(t){return d3.max(t.values,function(t){return t.volume})})]);var d=t.selectAll("g").data(u).enter().append("g").attr("class","legend");d.append("rect").attr("x",0).attr("y",function(t,e){return 20*e}).attr("width",10).attr("height",10).style("fill",function(t){return s(t.name)}),d.append("text").style("font-size","12px").style("fill","#444").attr("x",13).attr("y",function(t,e){return 20*e+10}).text(function(t){return t.name.replace(/^\w/,t=>t.toUpperCase())}),yticks=t.append("g").attr("transform","translate("+n+","+l.top+")").attr("class","y axis").call(i).append("text").attr("transform","rotate(-90)").attr("y",n-6).attr("dy",".71em").style("text-anchor","end").style("fill","black").text("Volume");t.selectAll(".city").data(u).enter().append("g").attr("class","city").append("path").attr("class","line").attr("d",function(t){return c(t.values)}).style("stroke",function(t){return s(t.name)});var p=t.append("g").attr("class","mouse-over-effects");p.append("path").attr("class","mouse-line").style("stroke","black").style("stroke-width","1px").style("opacity","0");var y=document.getElementsByClassName("line"),f=p.selectAll(".mouse-per-line").data(u).enter().append("g").attr("class","mouse-per-line");f.append("circle").attr("r",7).style("stroke",function(t){return s(t.name)}).style("fill","none").style("stroke-width","1px").style("opacity","0"),f.append("rect").attr("x",10).attr("y",-8).attr("width",50).attr("height",18).style("opacity","0").style("fill",function(t){return s(t.name)}),f.append("text").attr("transform","translate(10,6)").style("fill","white"),p.append("rect").attr("width",n).attr("height",a).attr("fill","none").attr("pointer-events","all").on("mouseout",function(){d3.select(".mouse-line").style("opacity","0"),d3.selectAll(".mouse-per-line circle").style("opacity","0"),d3.selectAll(".mouse-per-line text").style("opacity","0"),d3.selectAll(".mouse-per-line rect").style("opacity","0")}).on("mouseover",function(){d3.select(".mouse-line").style("opacity","1"),d3.selectAll(".mouse-per-line circle").style("opacity","1"),d3.selectAll(".mouse-per-line text").style("opacity","1"),d3.selectAll(".mouse-per-line rect").style("opacity","1")}).on("mousemove",function(){var t=d3.mouse(this);console.log("Mouse:",t),d3.select(".mouse-line").attr("d",function(){var e="M"+t[0]+","+a;return e+=" "+t[0]+",0"}),d3.selectAll(".mouse-per-line").attr("transform",function(e,l){console.log(n/t[0]);var a=r.invert(t[0]),i=d3.bisector(function(t){return t.date}).right;idx=i(e.values,a),console.log("xDate:",a),console.log("bisect",i),console.log("idx:",idx);var c=0,u=y[l].getTotalLength(),d=null;for(console.log("end",u);;){if(d=Math.floor((c+u)/2),console.log("Target:",d),pos=y[l].getPointAtLength(d),console.log("Position",pos.y),console.log("What is the position here:",pos),(d===u||d==c)&&pos.x!==t[0])break;if(pos.x>t[0])u=d;else{if(!(pos.x<t[0]))break;c=d}}return d3.select(this).select("text").text(o.invert(pos.y).toFixed(0)).attr("fill",function(t){return s(t.name)}),"translate("+t[0]+","+pos.y+")"})}),updateg3=function(t,e){d3.select(".mouse-line").style("opacity","1"),d3.selectAll(".mouse-per-line circle").style("opacity","1"),d3.selectAll(".mouse-per-line text").style("opacity","1"),d3.selectAll(".mouse-per-line rect").style("opacity","1");var l=d3.scaleLinear().domain([1,240]).range([0,n]);mousex=l(e),d3.select(".mouse-line").attr("d",function(){var t="M"+mousex+","+a;return t+=" "+mousex+",0"}),d3.selectAll(".mouse-per-line").attr("transform",function(t,l){console.log(mousex);var n=r.invert(e),a=d3.bisector(function(t){return t.date}).right;idx=a(t.values,n),console.log("xDate:",n),console.log("bisect",a),console.log("idx:",idx);var i=0,c=y[l].getTotalLength(),u=null;for(console.log("end",c);;){if(u=Math.floor((i+c)/2),console.log("Target:",u),pos=y[l].getPointAtLength(u),console.log("Position",pos.y),console.log("What is the position here:",pos),(u===c||u==i)&&pos.x!==e)break;if(pos.x>e)c=u;else{if(!(pos.x<e))break;i=u}}return d3.select(this).select("text").text(o.invert(pos.y).toFixed(0)).attr("fill",function(t){return s(t.name)}),"translate("+mousex+","+pos.y+")"}),console.log(e,f)}})}function getTimeOfOneDay(t){var e=t.getHours(),l=t.getMinutes(),n=t.getSeconds();return[["hour",e+l/60+n/3600],["minute",l+n/60]]}function rotationTransform2(t,e,l){return"rotate("+("hour"==t[0]?t[1]%12*30:6*t[1])+","+e+","+l+")"}var showD3Clock=function(t,e){var l=t,n=l/2,a=t/2,r=4,o=l/2-r;!function(){for(var t=Math.round(.2*o),l=Math.round(.075*o),s=0;s<60;++s){var i,c;s%5==0?(i=t,c="hourtick"):(i=l,c="minutetick"),e.append("line").attr("class",c+" face").attr("x1",n).attr("y1",r).attr("x2",n).attr("y2",r+i).attr("transform","rotate("+6*s+","+n+","+a+")")}}(),e.selectAll("line.hand").data(function(){var t=new Date,e=t.getHours(),l=t.getMinutes(),n=t.getSeconds();return[["hour",e+l/60+n/3600],["minute",l+n/60]]}()).enter().append("line").attr("class",function(t){return t[0]+" hand"}).attr("x1",n).attr("y1",function(t){return a+function(t){return"second"==t[0]?Math.round(.25*o):Math.round(.1*o)}(t)}).attr("x2",n).attr("y2",function(t){return o-function(t){return"hour"==t[0]?Math.round(.45*o):Math.round(.9*o)}(t)}).attr("transform",function(t){return"rotate("+("hour"==t[0]?t[1]%12*30:6*t[1])+","+n+","+a+")"})};