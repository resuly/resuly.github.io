let dataNum=240,dataMax=219,dataMean=7.987,dataMin=0,linear=d3.scaleLinear().domain([0,dataMax]).range([.01,1]);var data,subdata,lPatchWidth=200,margin={top:50,right:20,bottom:120,left:50},width=1200-margin.right-margin.left,height=550-margin.top-margin.bottom,cellSize=width/46.4,x_elements=[1,2,3,4,5,6,7,8],y_elements=[16,15,14,13,12,11,10,9,8,7,6,5,4,3,2,1],xScale=d3.scaleBand().domain(x_elements).range([0,x_elements.length*cellSize]),xAxis=d3.axisBottom().scale(xScale).tickFormat(function(t){return t}),yScale=d3.scaleBand().domain(y_elements).range([0,y_elements.length*cellSize]),yAxis=d3.axisLeft().scale(yScale).tickFormat(function(t){return t}),legendScale=d3.scaleLinear().domain([dataMax,dataMin]).range([0,y_elements.length*cellSize]),legendAxis=d3.axisRight().scale(legendScale).tickFormat(function(t){return t});tooltip=d3.select("body").append("div").attr("class","tooltip"),toolval=tooltip.append("div"),window.onload=function(){d3.json("http://7xml0w.com1.z0.glb.clouddn.com/bike_comparison.json").then(function(t){function e(t,e,a){t.selectAll("rect").remove(),t.selectAll("rect").data(e).enter().append("rect").attr("class","cell").attr("width",cellSize).attr("height",cellSize).attr("x",function(t,e){return xScale(t[1])}).attr("y",function(t,e){return yScale(t[0])}).attr("fill",function(t){return t[2]<0&&(t[2]=0),"in"==a?d3.interpolateBuPu(linear(t[2])):d3.interpolateGnBu(linear(t[2]))}).on("mouseover",function(t){d3.select(this).style("opacity",.5)}).on("mouseout",function(){d3.select(this).style("stroke","none"),d3.select(this).style("opacity",1),tooltip.style("visibility","hidden")}).on("mousemove",function(t){tooltip.style("visibility","visible").style("top",d3.event.pageY-30+"px").style("left",d3.event.pageX+20+"px"),tooltip.select("div").html("flow: "+t[2])})}function a(){var t=parseInt(k(v));F.attr("cx",b(b.invert(v))),P.text(data[t].t),subdata=data[t],e(n,subdata.in[0],"in"),e(i,subdata.in[1],"in"),e(d,subdata.out[0],"out"),e(s,subdata.out[1],"out"),r(new Date(data[t].t)),d3.select("#in_rmse").text(data[t].in_rmse),d3.select("#out_rmse").text(data[t].out_rmse),(v+=z/151)>z&&(S=!1,v=0,clearInterval(timer),w.text("Play"),console.log("Slider moving: "+S))}function r(t){u.selectAll("line.hand").data(getTimeOfOneDay(t)).attr("transform",function(t){var e=7*cellSize/2,a=7*cellSize/2;return"rotate("+("hour"==t[0]?t[1]%12*30:6*t[1])+","+e+","+a+")"})}dataMax=t.max,dataMean=t.mean,data=t.data,invertcolors=0,invertcolors&&colorHold.reverse();var l=d3.select(".heatmap").append("svg").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom);d3.select(".heatmap").style("width",width+margin.left+margin.right);var n=l.append("g").attr("transform","translate("+margin.left+","+margin.top+")"),i=l.append("g").attr("transform","translate("+(margin.left+8.5*cellSize)+","+margin.top+")"),d=l.append("g").attr("transform","translate("+(margin.left+19*cellSize)+","+margin.top+")"),s=l.append("g").attr("transform","translate("+(margin.left+27.5*cellSize)+","+margin.top+")");create_heatmap(1,n,data[0].in[0],dataMean,"in"),create_heatmap(2,i,data[0].in[1],dataMean,"in"),create_heatmap(3,d,data[0].out[0],dataMean,"out"),create_heatmap(4,s,data[0].out[1],dataMean,"out"),d3.select("#in_rmse").text(data[0].in_rmse),d3.select("#out_rmse").text(data[0].out_rmse);var o=l.append("defs"),c=o.append("linearGradient").attr("id","linear-gradient-in"),m=o.append("linearGradient").attr("id","linear-gradient-out");c.attr("x1","0%").attr("y1","0%").attr("x2","0%").attr("y2","100%"),m.attr("x1","0%").attr("y1","0%").attr("x2","0%").attr("y2","100%");for(var p=0;p<=100;p++)c.append("stop").attr("offset",p+"%").attr("stop-color",d3.interpolateBuPu(1-p/100)),m.append("stop").attr("offset",p+"%").attr("stop-color",d3.interpolateGnBu(1-p/100));legend1=l.append("g"),legend1.attr("transform","translate("+19*cellSize+","+margin.top+")"),legend1.append("rect").attr("width",.5*cellSize).attr("height",16*cellSize).style("fill","url(#linear-gradient-in)"),legend2=l.append("g"),legend2.attr("transform","translate("+38*cellSize+","+margin.top+")"),legend2.append("rect").attr("width",.5*cellSize).attr("height",16*cellSize).style("fill","url(#linear-gradient-out)"),legend1.append("g").attr("transform","translate(10,-10)").attr("class","y axis").call(legendAxis),legend2.append("g").attr("transform","translate(10,-10)").attr("class","y axis").call(legendAxis);var g=l.append("g").attr("transform","translate(0,"+(margin.top-10)+")");g.append("text").attr("x",4*cellSize).attr("class","headtitle in").text("Flow In - Real"),g.append("text").attr("x",12.2*cellSize).attr("class","headtitle in").text("Flow In - Prediction"),g.append("text").attr("x",23*cellSize).attr("class","headtitle out").text("Flow Out - Real"),g.append("text").attr("x",30.8*cellSize).attr("class","headtitle out").text("Flow Out - Prediction");var u=l.append("g").attr("class","clock").attr("transform","translate("+(margin.left+39.5*cellSize)+","+margin.top+")"),x=(d3.timeFormat("%Y"),d3.timeFormat("%Y-%m-%d %H:%M:%S")),h=d3.timeFormat("%m/%d"),f=(d3.timeParse("%m/%d/%y"),new Date("2014-09-21")),y=new Date("2014-10-01"),S=!1,v=0,z=width-9.5*cellSize,w=d3.select("#play-button"),_=d3.select("#error");w.style("top",11*cellSize).style("right",3*cellSize),_.style("width",7*cellSize).style("top",14*cellSize).style("right",.7*cellSize);var b=d3.scaleTime().domain([f,y]).range([0,z]).clamp(!0),k=d3.scaleLinear().domain([b.range()[0],b.range()[1]]).range([0,data.length-1]).clamp(!0),M=l.append("g").attr("class","slider").attr("transform","translate("+margin.left+","+20*cellSize+")");M.append("line").attr("class","track").attr("x1",b.range()[0]).attr("x2",b.range()[1]).select(function(){return this.parentNode.appendChild(this.cloneNode(!0))}).attr("class","track-inset").select(function(){return this.parentNode.appendChild(this.cloneNode(!0))}).attr("class","track-overlay").call(d3.drag().on("start",function(){M.interrupt()}).on("drag",function(){v=d3.event.x;var t=parseInt(k(v));F.attr("cx",b(b.invert(v))),P.text(data[t].t),console.log("currentFrame",t),subdata=data[t],e(n,subdata.in[0],"in"),e(i,subdata.in[1],"in"),e(d,subdata.out[0],"out"),e(s,subdata.out[1],"out"),r(new Date(data[t].t)),d3.select("#in_rmse").text(data[t].in_rmse),d3.select("#out_rmse").text(data[t].out_rmse)})),M.insert("g",".track-overlay").attr("class","ticks").attr("transform","translate(0,18)").selectAll("text").data(b.ticks(11)).enter().append("text").attr("x",b).attr("y",10).attr("text-anchor","middle").text(function(t){return h(t)});var F=M.insert("circle",".track-overlay").attr("class","handle").attr("r",9),P=u.append("text").attr("class","label").style("fill","#336").attr("text-anchor","middle").text(x(f)).attr("transform","translate("+3.5*cellSize+","+8*cellSize+")").text(data[0].t);w.on("click",function(){var t=d3.select(this);"Pause"==t.text()?(S=!1,clearInterval(timer),t.text("Play")):(S=!0,timer=setInterval(a,300),t.text("Pause")),console.log("Slider moving: "+S)}),showD3Clock(7*cellSize,u),r(new Date(data[0].t))})};